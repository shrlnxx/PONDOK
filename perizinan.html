<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modul Perizinan - SIMPEL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .tab-btn {
            background: none;
            border: none;
            color: rgb(148, 163, 184);
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            border-radius: 0.75rem;
            white-space: nowrap;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-btn:hover {
            color: white;
            background: rgba(99, 102, 241, 0.1);
        }

        .tab-btn.active {
            color: white;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-AKTIF {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .status-SELESAI {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-TERLAMBAT {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
    </style>
</head>

<body>
    <div id="app"></div>

    <script src="assets/js/main.js"></script>
    <script>
        // Inject layout
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            renderLayout('perizinan');

            // Update System Header
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) {
                pageTitle.innerText = 'Modul Perizinan';
                document.getElementById('pageSubtitle').innerText = 'Kelola izin keluar masuk santri terintegrasi';

                // Add Clock to Header
                const header = document.querySelector('header');
                const clockDiv = document.createElement('div');
                clockDiv.id = 'clock';
                clockDiv.className = 'bg-slate-800/70 backdrop-blur-xl border border-white/10 rounded-xl px-4 py-2 font-mono text-xl font-bold text-white hidden sm:block';
                clockDiv.innerText = '--:--';
                header.appendChild(clockDiv);
            }

            // Append Custom Content to Main (Preserving Header)
            const main = document.querySelector('main');
            const contentContainer = document.createElement('div');

<<<<<<< HEAD
            contentContainer.innerHTML = `
=======
            // Custom Layout for Permissions Module (with mobile hamburger button)
            main.innerHTML = `
                <!-- Mobile Menu Button (Fixed for mobile) -->
                <div class="lg:hidden fixed top-4 left-4 z-50">
                    <button class="bg-slate-800/90 backdrop-blur-xl border border-white/10 p-3 rounded-xl text-white text-2xl hover:text-indigo-400 hover:bg-slate-700/90 transition-all shadow-lg" 
                            onclick="document.getElementById('sidebar').classList.add('active'); document.getElementById('sidebar-overlay').classList.remove('hidden')">
                        <i class='bx bx-menu'></i>
                    </button>
                </div>

                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 mt-16 lg:mt-0">
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-1">Modul Perizinan</h2>
                        <p class="text-slate-400">Kelola izin keluar masuk santri terintegrasi</p>
                    </div>
                    <div id="clock" class="bg-slate-800/70 backdrop-blur-xl border border-white/10 rounded-xl px-4 py-2 font-mono text-xl font-bold text-white">--:--</div>
                </div>

>>>>>>> 51cb28ad1fb7b056ba90b7cfcef801fb68fac1ab
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('dashboard')"><i class='bx bxs-dashboard'></i> Dashboard Izin</button>
                    <button class="tab-btn" onclick="switchTab('input')"><i class='bx bxs-file-plus'></i> Input Izin</button>
                    <button class="tab-btn" onclick="switchTab('data')"><i class='bx bxs-data'></i> Data Perizinan</button>
                    <button class="tab-btn" onclick="switchTab('settings')"><i class='bx bxs-cog'></i> Pengaturan</button>
                </div>

                <!-- 1. DASHBOARD SECTION -->
                <div id="sec-dashboard" class="section active">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <div class="bg-slate-800/70 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-xl">
                            <div class="flex items-center gap-4">
                                <div class="bg-indigo-500/20 p-3 rounded-xl">
                                    <i class='bx bxs-calendar-check text-3xl text-indigo-400'></i>
                                </div>
                                <div>
                                    <h2 id="d-today" class="text-3xl font-bold text-white">0</h2>
                                    <span class="text-sm text-slate-400">Izin Hari Ini</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-slate-800/70 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-xl">
                            <div class="flex items-center gap-4">
                                <div class="bg-amber-500/20 p-3 rounded-xl">
                                    <i class='bx bxs-timer text-3xl text-amber-400'></i>
                                </div>
                                <div>
                                    <h2 id="d-active" class="text-3xl font-bold text-white">0</h2>
                                    <span class="text-sm text-slate-400">Sedang Izin</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-slate-800/70 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-xl">
                            <div class="flex items-center gap-4">
                                <div class="bg-red-500/20 p-3 rounded-xl">
                                    <i class='bx bxs-alarm-exclamation text-3xl text-red-400'></i>
                                </div>
                                <div>
                                    <h2 id="d-late" class="text-3xl font-bold text-white">0</h2>
                                    <span class="text-sm text-slate-400">Terlambat</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-800/70 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-xl">
                        <h3 class="text-xl font-bold text-white mb-4">Aktivitas Terbaru</h3>
<<<<<<< HEAD
                        <div class="overflow-x-auto rounded-xl border border-white/5 bg-slate-900/30">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-indigo-900/50 backdrop-blur-sm border-b border-white/10">
                                        <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider text-indigo-300">Waktu Keluar</th>
                                        <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider text-indigo-300">Santri</th>
                                        <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider text-indigo-300">Tujuan</th>
                                        <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider text-indigo-300">Rencana Kembali</th>
                                        <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider text-indigo-300">Status</th>
                                        <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider text-indigo-300">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="d-recent" class="divide-y divide-white/5">
                                    <tr><td colspan="6" class="text-center py-8 text-slate-400">Memuat...</td></tr>
                                </tbody>
                            </table>
=======
                        <!-- Responsive table wrapper with horizontal scroll on mobile -->
                        <div class="overflow-x-auto -mx-6 px-6 sm:mx-0 sm:px-0">
                            <div class="inline-block min-w-full align-middle">
                                <div class="overflow-hidden rounded-xl border border-white/5 bg-slate-900/30">
                                    <table class="min-w-full border-collapse">
                                        <thead>
                                            <tr class="bg-indigo-900/50 backdrop-blur-sm border-b border-white/10">
                                                <th class="text-left py-4 px-4 sm:px-6 text-xs font-bold uppercase tracking-wider text-indigo-300 whitespace-nowrap">Waktu Keluar</th>
                                                <th class="text-left py-4 px-4 sm:px-6 text-xs font-bold uppercase tracking-wider text-indigo-300 whitespace-nowrap">Santri</th>
                                                <th class="text-left py-4 px-4 sm:px-6 text-xs font-bold uppercase tracking-wider text-indigo-300 whitespace-nowrap">Tujuan</th>
                                                <th class="text-left py-4 px-4 sm:px-6 text-xs font-bold uppercase tracking-wider text-indigo-300 whitespace-nowrap">Rencana Kembali</th>
                                                <th class="text-left py-4 px-4 sm:px-6 text-xs font-bold uppercase tracking-wider text-indigo-300 whitespace-nowrap">Status</th>
                                                <th class="text-left py-4 px-4 sm:px-6 text-xs font-bold uppercase tracking-wider text-indigo-300 whitespace-nowrap">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="d-recent" class="divide-y divide-white/5">
                                            <tr><td colspan="6" class="text-center py-8 text-slate-400">Memuat...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
>>>>>>> 51cb28ad1fb7b056ba90b7cfcef801fb68fac1ab
                        </div>
                        <!-- Mobile scroll hint -->
                        <p class="text-xs text-slate-500 mt-2 sm:hidden text-center">
                            <i class='bx bx-swipe-left'></i> Geser ke kiri untuk melihat lebih banyak
                        </p>
                    </div>
                </div>

                <!-- 2. INPUT SECTION -->
                <div id="sec-input" class="section">
                    <div class="bg-slate-800/70 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-xl max-w-2xl mx-auto">
                        <h3 class="text-xl font-bold text-white mb-6">Formulir Izin Keluar</h3>
                        <form id="formIzin" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Nama Santri</label>
                                <div class="relative">
                                    <input type="text" id="cariSantri" class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="Ketik Nama / NIS..." autocomplete="off">
                                    <div id="hasilCari" class="search-dropdown hidden"></div>
                                </div>
                                <input type="hidden" name="nis" id="nisSantri" required>
                                <small id="infoSantri" class="block mt-2 text-sm text-indigo-400 font-bold min-h-[1.2em]"></small>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Tujuan Izin</label>
                                <input type="text" name="tujuan" class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="Contoh: Berobat, Urusan Keluarga..." required>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Waktu Keluar</label>
                                    <input type="datetime-local" name="waktu_keluar" id="inpKeluar" class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Rencana Kembali</label>
                                    <input type="datetime-local" name="rencana_kembali" id="inpKembali" class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" required>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Keterangan Tambahan</label>
                                <textarea name="keterangan" rows="2" class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"></textarea>
                            </div>

                            <div id="submitStatus" class="mb-3 font-bold text-indigo-400"></div>

                            <button type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all">
                                Simpan & Cetak Surat
                            </button>
                        </form>
                    </div>
                </div>

                <!-- 3. DATA SECTION -->
                <div id="sec-data" class="section">
                    <div class="bg-slate-800/70 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-xl">
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-white mb-4">Data Perizinan</h3>
                            
                            <!-- ADVANCED FILTER -->
                            <div class="bg-black/20 border border-white/5 rounded-xl p-4 mb-6">
                                <small class="block text-slate-400 mb-3 font-medium uppercase tracking-wider">Filter Data:</small>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-7 gap-3">
                                    <div>
                                        <label class="block text-xs text-slate-400 mb-1">Dari Tanggal</label>
                                        <input type="date" id="startDate"
                                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-400 mb-1">Sampai Tanggal</label>
                                        <input type="date" id="endDate"
                                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-400 mb-1">Status</label>
                                        <select id="filterStatus" class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                                            <option value="">Semua Status</option>
                                            <option value="AKTIF">Aktif</option>
                                            <option value="SELESAI">Selesai</option>
                                            <option value="TERLAMBAT">Terlambat</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-400 mb-1">Nama Santri</label>
                                        <input type="text" id="filterNama"
                                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                                            placeholder="Cari Nama...">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-slate-400 mb-1">Kelas</label>
                                        <input type="text" id="filterKelas"
                                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                                            placeholder="Semua Kelas">
                                    </div>
                                    <div class="flex items-end">
                                        <button onclick="loadList()"
                                            class="w-full px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                                            <i class='bx bx-filter'></i> Tampilkan
                                        </button>
                                    </div>
                                    <div class="flex items-end">
                                        <button onclick="resetFilter()"
                                            class="w-full px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2"
                                            title="Reset semua filter">
                                            <i class='bx bx-reset'></i> Reset
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
<<<<<<< HEAD
                        <div class="overflow-x-auto rounded-xl border border-white/5 bg-slate-900/30">
                            <table class="w-full border-collapse">
                                <thead>
                                    <tr class="bg-indigo-900/50 backdrop-blur-sm border-b border-white/10">
                                        <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider text-indigo-300">Waktu Keluar</th>
                                        <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider text-indigo-300">Santri</th>
                                        <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider text-indigo-300">Tujuan</th>
                                        <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider text-indigo-300">Rencana Kembali</th>
                                        <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider text-indigo-300">Status</th>
                                        <th class="text-left py-4 px-6 text-xs font-bold uppercase tracking-wider text-indigo-300">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="listData" class="divide-y divide-white/5"></tbody>
                            </table>
=======
                        <!-- Responsive table wrapper -->
                        <div class="overflow-x-auto -mx-6 px-6 sm:mx-0 sm:px-0">
                            <div class="inline-block min-w-full align-middle">
                                <div class="overflow-hidden rounded-xl border border-white/5 bg-slate-900/30">
                                    <table class="min-w-full border-collapse">
                                        <thead>
                                            <tr class="bg-indigo-900/50 backdrop-blur-sm border-b border-white/10">
                                                <th class="text-left py-4 px-4 sm:px-6 text-xs font-bold uppercase tracking-wider text-indigo-300 whitespace-nowrap">Waktu Keluar</th>
                                                <th class="text-left py-4 px-4 sm:px-6 text-xs font-bold uppercase tracking-wider text-indigo-300 whitespace-nowrap">Santri</th>
                                                <th class="text-left py-4 px-4 sm:px-6 text-xs font-bold uppercase tracking-wider text-indigo-300 whitespace-nowrap">Tujuan</th>
                                                <th class="text-left py-4 px-4 sm:px-6 text-xs font-bold uppercase tracking-wider text-indigo-300 whitespace-nowrap">Rencana Kembali</th>
                                                <th class="text-left py-4 px-4 sm:px-6 text-xs font-bold uppercase tracking-wider text-indigo-300 whitespace-nowrap">Status</th>
                                                <th class="text-left py-4 px-4 sm:px-6 text-xs font-bold uppercase tracking-wider text-indigo-300 whitespace-nowrap">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="listData" class="divide-y divide-white/5"></tbody>
                                    </table>
                                </div>
                            </div>
>>>>>>> 51cb28ad1fb7b056ba90b7cfcef801fb68fac1ab
                        </div>
                        <!-- Mobile scroll hint -->
                        <p class="text-xs text-slate-500 mt-2 sm:hidden text-center">
                            <i class='bx bx-swipe-left'></i> Geser ke kiri untuk melihat lebih banyak
                        </p>
                    </div>
                </div>

                <!-- 4. SETTINGS SECTION -->
                <div id="sec-settings" class="section">
                    <div class="bg-slate-800/70 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-xl max-w-lg">
                        <h3 class="text-xl font-bold text-white mb-6">Pengaturan Perizinan</h3>
                        <form id="formSettings" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Durasi Default (Jam)</label>
                                <input type="number" name="default_duration_hours" class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Toleransi Keterlambatan (Menit)</label>
                                <input type="number" name="tolerance_minutes" class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Batas Jam Malam (HH:MM)</label>
                                <input type="time" name="max_night_hour" class="w-full px-4 py-3 bg-slate-900/50 border border-slate-700 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                            </div>
                            <button type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all">Simpan Pengaturan</button>
                        </form>
                    </div>
                </div>
            `;
            main.appendChild(contentContainer);

            // Initialize Clock
            setInterval(() => {
                const c = document.getElementById('clock');
                if (c) c.innerText = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            }, 1000);

            // Load Initial Dashboard
            loadDashboard();
            loadSettings(); // Prepare settings for input calculation

            // Setup Search
            setupSearch();

            // Set default date times
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('inpKeluar').value = now.toISOString().slice(0, 16);

            // Add default 3 hours
            const later = new Date(now);
            later.setHours(later.getHours() + 3);
            document.getElementById('inpKembali').value = later.toISOString().slice(0, 16);
        });

        // TABS LOGIC
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

            // Find button by onclick attribute text usually, but simple index matching is safer or just querying
            // Shortcuts:
            const idx = ['dashboard', 'input', 'data', 'settings'].indexOf(tab);
            document.querySelectorAll('.tab-btn')[idx].classList.add('active');
            document.getElementById(`sec-${tab}`).classList.add('active');

            if (tab === 'dashboard') loadDashboard();
            if (tab === 'data') loadList();
            if (tab === 'settings') loadSettings();
        };

        // API CALLS
        async function loadDashboard() {
            const res = await apiCall('perizinan.php?action=stats');
            if (res) {
                // Safe access with fallback to 0
                document.getElementById('d-today').innerText = res.today || 0;
                document.getElementById('d-active').innerText = res.active || 0;
                document.getElementById('d-late').innerText = res.late || 0;

                const tbody = document.getElementById('d-recent');
                tbody.innerHTML = '';

                // Check if recent exists and is an array
                if (!res.recent || !Array.isArray(res.recent) || res.recent.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-400">Belum ada aktivitas</td></tr>';
                } else {
                    res.recent.forEach(r => {
                        tbody.innerHTML += renderRow(r);
                    });
                }
            } else {
                // If API fails completely, show 0s
                document.getElementById('d-today').innerText = '0';
                document.getElementById('d-active').innerText = '0';
                document.getElementById('d-late').innerText = '0';
                document.getElementById('d-recent').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-400">Tidak dapat memuat data</td></tr>';
            }
        }

        async function loadList() {
            const status = document.getElementById('filterStatus').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const nama = document.getElementById('filterNama').value;
            const kelas = document.getElementById('filterKelas').value;

            let query = `perizinan.php?action=list&status=${status}`;
            if (startDate) query += `&start=${startDate}`;
            if (endDate) query += `&end=${endDate}`;
            if (nama) query += `&nama=${encodeURIComponent(nama)}`;
            if (kelas) query += `&kelas=${encodeURIComponent(kelas)}`;

            const res = await apiCall(query);
            const tbody = document.getElementById('listData');
            tbody.innerHTML = '';

            if (!res || res.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-12">
                            <i class='bx bx-search-alt text-4xl text-slate-600 mb-2'></i>
                            <p class="text-slate-400">Data tidak ditemukan</p>
                        </td>
                    </tr>`;
            } else {
                res.forEach(r => tbody.innerHTML += renderRow(r));
            }
        }

        // Reset Filter Function
        function resetFilter() {
            // Clear all filter inputs
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterNama').value = '';
            document.getElementById('filterKelas').value = '';

            // Reload data without filters
            loadList();

            // Visual feedback
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="bx bx-check"></i> Reset!';
            btn.classList.add('bg-green-600');

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('bg-green-600');
            }, 1000);
        }

        function renderRow(r) {
            let label = r.status;
            let badgeClass = '';
            let rowClass = 'group hover:bg-white/5 transition-all duration-300 border-b border-indigo-500/5 last:border-0';

            // DYNAMIC STATUS CALCULATION
            const now = new Date();
            // Ensure safe date parsing for Safari/older browsers (replace space with T)
            const planTime = new Date(r.rencana_kembali.replace(' ', 'T'));
            const isOverdue = now > planTime;

            if (!r.waktu_kembali) {
                // STATUS SAAT MASIH DI LUAR (BELUM KEMBALI)
                // User ingin status tetap AKTIF/SEDANG IZIN sampai diklik ceklis
                label = 'SEDANG IZIN';
                badgeClass = 'bg-amber-500/10 text-amber-400 border border-amber-500/20 shadow-[0_0_15px_rgba(245,158,11,0.1)]';

                if (isOverdue) {
                    // Indikator telat tetap ada sebagai pengingat, tapi label utama tetap SEDANG IZIN
                    label = 'SEDANG IZIN (TERLAMBAT!)';
                    badgeClass = 'bg-red-500/10 text-red-400 border border-red-500/20 animate-pulse';
                }
            } else {
                // STATUS SETELAH KEMBALI (KONFIRMASI SELESAI)
                if (r.status === 'TERLAMBAT') {
                    label = 'KEMBALI TERLAMBAT';
                    badgeClass = 'bg-rose-500/10 text-rose-400 border border-rose-500/20';
                } else {
                    label = 'TEPAT WAKTU';
                    badgeClass = 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20';
                }
            }

            const badge = `<span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[11px] font-bold tracking-wide uppercase ${badgeClass}">
                <i class='bx ${label.includes('TERLAMBAT') ? 'bx-error-circle' : 'bx-check-circle'} text-sm'></i>
                ${label}
            </span>`;

            let btn = '';
            // Tampilkan tombol KEMBALI (checklist) selama santri belum kembali
            if (!r.waktu_kembali) {
                btn = `<button onclick="doReturn(${r.id}, '${r.rencana_kembali}')" 
                    class="inline-flex items-center gap-1.5 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg hover:shadow-emerald-500/30 transform hover:scale-105 transition-all duration-300 text-xs tracking-wide" 
                    title="Klik jika santri sudah kembali">
                    <i class='bx bx-check-circle text-lg'></i> CEKLIS KEMBALI
                </button>`;
            }
            const printBtn = `<button onclick="doPrint(${r.id})" 
                class="inline-flex items-center gap-1.5 px-4 py-2 border border-white/10 bg-white/5 hover:bg-white/10 text-slate-300 hover:text-white rounded-lg font-semibold transition-all duration-300 text-xs backdrop-blur-sm" 
                title="Cetak Surat">
                <i class='bx bx-printer text-lg'></i>
            </button>`;

            return `
                <tr class="${rowClass}">
                    <td class="py-5 px-6">
                        <span class="font-mono text-indigo-300 text-sm tracking-wider">${r.waktu_keluar}</span>
                    </td>
                    <td class="py-5 px-6">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-slate-800 border border-indigo-500/30 flex items-center justify-center shadow-lg relative group-hover:scale-110 transition-transform duration-300">
                                <i class='bx bxs-user text-indigo-400'></i>
                            </div>
                            <div>
                                <div class="font-bold text-white text-base mb-1 tracking-wide">${r.nama}</div>
                                <div class="flex gap-2">
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-blue-500/10 text-blue-300 border border-blue-500/20 uppercase tracking-wider">
                                        <i class='bx bxs-school mr-1'></i> ${r.kelas || '?'}
                                    </span>
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-purple-500/10 text-purple-300 border border-purple-500/20 uppercase tracking-wider">
                                        <i class='bx bxs-building-house mr-1'></i> ${r.asrama || 'ASRAMA'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="py-5 px-6">
                        <div class="flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-slate-500"></span>
                            <span class="text-slate-300 text-sm font-medium">${r.tujuan_izin}</span>
                        </div>
                    </td>
                    <td class="py-5 px-6">
                        <span class="font-mono text-slate-400 text-sm tracking-wider">${r.rencana_kembali}</span>
                    </td>
                    <td class="py-5 px-6">${badge}</td>
                    <td class="py-5 px-6">
                        <div class="flex items-center gap-3">${btn}${printBtn}</div>
                    </td>
                </tr>
            `;
        }

        async function doReturn(id, planTime) {
            // Intelligent Confirmation
            const now = new Date(); // Current Client Time
            // Fix planTime string (ISO format compatibility)
            const plan = new Date(planTime.replace(' ', 'T'));

            const diffMs = now - plan;
            const diffMins = Math.floor(diffMs / 60000);
            const tolerance = parseInt(APP_SETTINGS.tolerance_minutes || 15);

            let msg = 'Santri sudah kembali?';

            if (diffMins > 0) {
                // Late
                if (diffMins <= tolerance) {
                    msg += `\n\nâš ï¸ INFO: Santri terlambat ${diffMins} menit.`;
                    msg += `\nâœ… Masih dalam toleransi (${tolerance} menit).`;
                    msg += `\nStatus akan dicatat TEPAT WAKTU (SELESAI).`;
                } else {
                    msg += `\n\nâ›” PERINGATAN: Santri terlambat ${diffMins} menit!`;
                    msg += `\nâŒ Melewati batas toleransi (${tolerance} menit).`;
                    msg += `\nStatus akan dicatat TERLAMBAT.`;
                }
            } else {
                msg += `\n\nâœ… Santri kembali tepat waktu (Sisa ${Math.abs(diffMins)} menit).`;
            }

            if (!confirm(msg)) return;

            const res = await apiCall('perizinan.php?action=return', 'POST', { id });
            if (res && res.status === 'success') {
                if (res.late) {
                    alert('Status tercatat: TERLAMBAT.');
                }
                loadDashboard();
                loadList();
            } else alert('Gagal update status: ' + (res?.message));
        }

        function doPrint(id) {
            window.open(`print_izin.html?id=${id}`, '_blank', 'width=400,height=600');
        }

        // INPUT LOGIC
        function setupSearch() {
            const input = document.getElementById('cariSantri');
            const box = document.getElementById('hasilCari');
            let t;
            input.addEventListener('keyup', () => {
                clearTimeout(t);
                t = setTimeout(async () => {
                    const q = input.value;
                    if (q.length < 2) { box.classList.add('hidden'); return; }
                    const res = await apiCall(`santri.php?action=search&q=${q}`);
                    box.innerHTML = '';
                    if (res && res.length > 0) {
                        box.classList.remove('hidden');
                        res.forEach(s => {
                            const d = document.createElement('div');
                            d.className = 'search-dropdown-item';
                            d.innerHTML = `<div class="text-white font-semibold">${s.nama}</div><div class="text-sm text-slate-400 font-mono">${s.nis} - ${s.kelas}</div>`;
                            d.onclick = () => {
                                input.value = s.nama;
                                document.getElementById('nisSantri').value = s.nis;
                                document.getElementById('infoSantri').innerText = `Santri: ${s.nama} (${s.kelas})`;
                                box.classList.add('hidden');
                            };
                            box.appendChild(d);
                        });
                    } else box.classList.add('hidden');
                }, 300);
            });
        }

        // DOCUMENT EVENT DELEGATION FOR FORM SUBMIT
        document.addEventListener('submit', async (e) => {
            if (e.target && e.target.id === 'formIzin') {
                e.preventDefault();

                const statusDiv = document.getElementById('submitStatus');
                if (statusDiv) {
                    statusDiv.innerText = 'Memproses...';
                    statusDiv.style.color = '#6366f1';
                }

                // Validate NIS (Soft Validation - Log warning but try to send)
                const nisVal = document.getElementById('nisSantri').value;
                if (!nisVal) {
                    if (!confirm('Santri belum dipilih dari list (NIS Kosong). Yakin ingin mencoba simpan? (Kemungkinan Gagal)')) {
                        if (statusDiv) {
                            statusDiv.innerText = 'Dibatalkan Pengguna (Pilih Santri Dulu)';
                            statusDiv.style.color = 'orange';
                        }
                        return;
                    }
                }

                // Disable button
                const btn = e.target.querySelector('button');
                const originalText = btn.innerText;
                btn.innerText = 'Menyimpan...';
                btn.disabled = true;

                const form = new FormData(e.target);
                const data = Object.fromEntries(form);

                // PRE-PROCESS DATES
                if (data.waktu_keluar) data.waktu_keluar = data.waktu_keluar.replace('T', ' ');
                if (data.rencana_kembali) data.rencana_kembali = data.rencana_kembali.replace('T', ' ');

                try {
                    if (statusDiv) statusDiv.innerText = 'Mengirim data ke server...';

                    console.log('ðŸ“¤ Sending data:', data);
                    const res = await apiCall('perizinan.php?action=create', 'POST', data);
                    console.log('ðŸ“¥ Response:', res);

                    if (res && res.status === 'success') {
                        if (statusDiv) {
                            statusDiv.innerText = 'Sukses! Mencetak...';
                            statusDiv.style.color = '#22c55e';
                        }

                        if (confirm('Izin Berhasil Dicatat! Cetak Struk sekarang?')) {
                            doPrint(res.id);
                        }

                        e.target.reset();
                        document.getElementById('nisSantri').value = '';
                        document.getElementById('infoSantri').innerText = '';
                        // Reset defaults
                        const now = new Date();
                        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                        document.getElementById('inpKeluar').value = now.toISOString().slice(0, 16);
                        const later = new Date(now);
                        later.setHours(later.getHours() + 3);
                        document.getElementById('inpKembali').value = later.toISOString().slice(0, 16);

                        setTimeout(() => { if (statusDiv) statusDiv.innerText = ''; }, 3000);
                        switchTab('dashboard');
                    } else {
                        // Better error message with more details
                        let errorMsg = 'Gagal menyimpan izin';

                        if (res && res.message) {
                            errorMsg = res.message;
                        } else if (!res) {
                            errorMsg = 'Tidak ada response dari server. Cek console untuk detail.';
                        }

                        console.error('âŒ Error detail:', res);

                        if (statusDiv) {
                            statusDiv.innerText = errorMsg;
                            statusDiv.style.color = '#ef4444';
                        }

                        // Show more detailed alert
                        alert('âš ï¸ GAGAL MENYIMPAN IZIN\n\n' + errorMsg + '\n\nSARAN:\n1. Pastikan database sudah disetup\n2. Jalankan fix_perizinan.php\n3. Refresh halaman ini\n4. Buka Console (F12) untuk detail error');
                    }
                } catch (error) {
                    const msg = 'Error Sistem: ' + error.message;
                    if (statusDiv) {
                        statusDiv.innerText = msg;
                        statusDiv.style.color = '#ef4444';
                    }
                    alert('Terjadi kesalahan sistem.');
                    console.error(error);
                } finally {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        });

        // GLOBAL SETTINGS
        let APP_SETTINGS = {
            tolerance_minutes: 15 // default
        };

        // SETTINGS LOGIC
        async function loadSettings() {
            const res = await apiCall('perizinan.php?action=settings');
            if (res) {
                APP_SETTINGS = res; // Store globally
                // ... fill form ...
                const form = document.getElementById('formSettings');
                if (form) {
                    if (res.default_duration_hours) form.default_duration_hours.value = res.default_duration_hours;
                    if (res.tolerance_minutes) form.tolerance_minutes.value = res.tolerance_minutes;
                    if (res.max_night_hour) form.max_night_hour.value = res.max_night_hour;
                }
            }
        }

        document.getElementById('formSettings').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = new FormData(e.target);
            const data = Object.fromEntries(form);
            const res = await apiCall('perizinan.php?action=settings', 'POST', data);
            if (res && res.status === 'success') alert('Pengaturan Disimpan');
        });

    </script>
</body>

</html>