<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Pelanggaran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/responsive.css?v=4">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        @media print {
            body {
                background: white;
                color: black;
            }

            .sidebar,
            .btn,
            .filter-grid,
            .page-header {
                display: none !important;
            }

            .main-content {
                margin: 0;
                padding: 0;
            }

            .glass-panel {
                box-shadow: none;
                border: none;
                padding: 0;
            }

            table {
                border: 1px solid black;
            }

            th {
                background: #eee;
                color: black;
                border: 1px solid black;
                padding: 5px;
            }

            td {
                border: 1px solid black;
                color: black;
                padding: 5px;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="bg-slate-800/70 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-xl">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 no-print">
                <div>
                    <h3 class="text-2xl font-bold text-white mb-2">Laporan Pelanggaran</h3>
                    <p class="text-slate-400">Filter dan export data pelanggaran</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="window.print()"
                        class="px-6 py-3 border-2 border-indigo-500 text-indigo-400 hover:bg-indigo-500/20 rounded-xl font-semibold transition-all flex items-center gap-2">
                        <i class='bx bxs-printer'></i> PDF / Print
                    </button>
                    <button onclick="exportExcel()"
                        class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
                        <i class='bx bxs-spreadsheet'></i> Excel
                    </button>
                </div>
            </div>

            <!-- FILTER SECTION -->
            <div class="bg-black/20 border border-white/5 rounded-xl p-4 mb-6 no-print">
                <small class="block text-slate-400 mb-3">Filter Data:</small>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-3">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Dari Tanggal</label>
                        <input type="date" id="startDate"
                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Sampai Tanggal</label>
                        <input type="date" id="endDate"
                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Nama Santri</label>
                        <input type="text" id="filterNama"
                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                            placeholder="Cari Nama...">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kelas</label>
                        <input type="text" id="filterKelas"
                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                            placeholder="Semua Kelas">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Asrama / Kamar</label>
                        <input type="text" id="filterAsrama"
                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                            placeholder="Semua Asrama">
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadReport()"
                            class="w-full px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                            <i class='bx bx-filter'></i> Tampilkan
                        </button>
                    </div>
                </div>
            </div>

            <!-- TABLE -->
            <div class="mt-4">
                <div class="overflow-x-auto">
                    <table id="reportTable" class="w-full">
                        <thead>
                            <tr class="border-b border-white/10">
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Tanggal</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Nama Santri</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Kelas</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Pelanggaran</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Status</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Penanganan /
                                    Petugas</th>
                            </tr>
                        </thead>
                        <tbody id="reportBody" class="divide-y divide-white/5">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-slate-400">Silakan set tanggal dan klik
                                    Tampilkan</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="resultCount" class="text-slate-400 text-sm text-right mt-3"></div>
            </div>
        </div>
    </div>

    <style>
        @media print {
            body {
                background: white !important;
                color: black !important;
            }

            .no-print {
                display: none !important;
            }

            .bg-slate-800\/70 {
                background: white !important;
                border: none !important;
                box-shadow: none !important;
            }

            table {
                border: 1px solid black;
            }

            th {
                background: #eee !important;
                color: black !important;
                border: 1px solid black;
                padding: 5px;
            }

            td {
                border: 1px solid black;
                color: black !important;
                padding: 5px;
            }
        }
    </style>

    <script src="assets/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            renderLayout('laporan');
            document.getElementById('pageTitle').innerText = 'Laporan';
            document.getElementById('pageSubtitle').innerText = 'Export & Filter';

            // Default: Hari ini
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('endDate').value = now.toISOString().split('T')[0];

            loadReport();
        });

        // Global variable untuk menyimpan raw data dari server
        let rawData = [];
        let filteredData = [];

        async function loadReport() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            const tbody = document.getElementById('reportBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Memuat data...</td></tr>';

            // 1. Ambil data dari API
            const res = await apiCall(`pelanggaran.php?action=list&start=${start}&end=${end}`);

            if (res && res.data) {
                rawData = res.data;
                applyFilters(); // 2. Terapkan filter teks
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Gagal memuat data</td></tr>';
            }
        }

        // Fungsi filter client-side yang responsif
        function applyFilters() {
            const fNama = document.getElementById('filterNama').value.toLowerCase();
            const fKelas = document.getElementById('filterKelas').value.toLowerCase();
            const fAsrama = document.getElementById('filterAsrama').value.toLowerCase();

            // Filter Array
            filteredData = rawData.filter(row => {
                const matchNama = row.nama?.toLowerCase().includes(fNama) || false;
                const matchKelas = row.kelas?.toLowerCase().includes(fKelas) || false;
                const matchAsrama = row.asrama?.toLowerCase().includes(fAsrama) || false;
                return matchNama && matchKelas && matchAsrama;
            });

            renderTable(filteredData);
        }

        function renderTable(data) {
            const tbody = document.getElementById('reportBody');
            tbody.innerHTML = '';

            if (data.length > 0) {
                document.getElementById('resultCount').innerText = `Menampilkan ${data.length} data`;

                data.forEach(row => {
                    // Warna status
                    let color = 'white';
                    if (row.status_penanganan?.includes('Selesai')) color = '#22c55e';
                    else if (row.status_penanganan?.includes('Belum')) color = '#ef4444';
                    else color = '#f59e0b';

                    // Info Petugas
                    const pelapor = row.pencatat || 'System';
                    const penangan = row.penangan ? row.penangan : '-';

                    tbody.innerHTML += `
                        <tr>
                            <td>${row.tanggal_kejadian}</td>
                            <td>
                                <strong>${row.nama}</strong><br>
                                <small style="opacity:0.7">${row.santri_nis}</small>
                            </td>
                            <td>
                                ${row.kelas}<br>
                                <small style="opacity:0.7">${row.asrama}</small>
                            </td>
                            <td>
                                ${row.jenis_pelanggaran}<br>
                                <span style="font-size:0.8em; opacity:0.7; border:1px solid rgba(255,255,255,0.2); padding: 0 4px; border-radius:4px;">${row.kategori}</span>
                            </td>
                            <td style="color:${color}; font-weight:bold;">${row.status_penanganan || 'Belum'}</td>
                            <td>
                                <div style="font-size:0.9em; line-height:1.4em;">
                                    Tindakan: ${row.tindakan_diambil || '-'}<br>
                                    <small style="opacity:0.6; display:block; margin-top:4px; border-top:1px solid rgba(255,255,255,0.1); padding-top:4px;">
                                        <i class='bx bxs-user-voice'></i> Lapor: ${pelapor}<br>
                                        <i class='bx bxs-user-check'></i> Eksekusi: ${penangan}
                                    </small>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada data yang cocok dengan filter</td></tr>';
                document.getElementById('resultCount').innerText = '';
            }
        }

        // Tambahkan event listener 
        ['filterNama', 'filterKelas', 'filterAsrama'].forEach(id => {
            document.getElementById(id).addEventListener('keyup', applyFilters);
        });

        function exportExcel() {
            if (filteredData.length === 0) {
                alert('Tidak ada data untuk diexport');
                return;
            }

            // Format data untuk excel agar rapi (termasuk kolom petugas)
            const excelData = filteredData.map(row => ({
                "Tanggal": row.tanggal_kejadian,
                "NIS": row.santri_nis,
                "Nama Santri": row.nama,
                "Kelas": row.kelas,
                "Asrama": row.asrama,
                "Pelanggaran": row.jenis_pelanggaran,
                "Status": row.status_penanganan,
                "Tindakan": row.tindakan_diambil || '-',
                "Pelapor": row.pencatat || 'System',
                "Penangan (Eksekutor)": row.penangan || '-'
            }));

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan SimpelPanel");
            XLSX.writeFile(wb, "Laporan_Pelanggaran_Lengkap.xlsx");
        }
    </script>
</body>

</html>