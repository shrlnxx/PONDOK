<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Pelanggaran</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/responsive.css?v=4">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        @media print {
            body {
                background: white;
                color: black;
            }

            .sidebar,
            .btn,
            .filter-grid,
            .page-header {
                display: none !important;
            }

            .main-content {
                margin: 0;
                padding: 0;
            }

            .glass-panel {
                box-shadow: none;
                border: none;
                padding: 0;
            }

            table {
                border: 1px solid black;
            }

            th {
                background: #eee;
                color: black;
                border: 1px solid black;
                padding: 5px;
            }

            td {
                border: 1px solid black;
                color: black;
                padding: 5px;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="bg-slate-800/70 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-xl">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6 no-print">
                <div>
                    <h3 class="text-2xl font-bold text-white mb-2">Laporan Pelanggaran</h3>
                    <p class="text-slate-400">Filter dan export data pelanggaran</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="window.print()"
                        class="px-6 py-3 border-2 border-indigo-500 text-indigo-400 hover:bg-indigo-500/20 rounded-xl font-semibold transition-all flex items-center gap-2">
                        <i class='bx bxs-printer'></i> PDF / Print
                    </button>
                    <button onclick="exportExcel()"
                        class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
                        <i class='bx bxs-spreadsheet'></i> Excel
                    </button>
                </div>
            </div>

            <!-- FILTER SECTION -->
            <div class="bg-black/20 border border-white/5 rounded-xl p-4 mb-6 no-print">
                <small class="block text-slate-400 mb-3">Filter Data:</small>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-7 gap-3">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Dari Tanggal</label>
                        <input type="date" id="startDate"
                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Sampai Tanggal</label>
                        <input type="date" id="endDate"
                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Nama Santri</label>
                        <input type="text" id="filterNama"
                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                            placeholder="Cari Nama...">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kelas</label>
                        <input type="text" id="filterKelas"
                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                            placeholder="Semua Kelas">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Asrama / Kamar</label>
                        <input type="text" id="filterAsrama"
                            class="w-full px-3 py-2 bg-slate-900/50 border border-slate-700 rounded-lg text-white text-sm placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                            placeholder="Semua Asrama">
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadReport()"
                            class="w-full px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                            <i class='bx bx-filter'></i> Tampilkan
                        </button>
                    </div>
                    <div class="flex items-end">
                        <button onclick="resetFilter(event)"
                            class="w-full px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2"
                            title="Reset semua filter">
                            <i class='bx bx-reset'></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- TABLE -->
            <div class="mt-4">
                <div class="overflow-x-auto">
                    <table id="reportTable" class="w-full">
                        <thead>
                            <tr class="border-b border-white/10">
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Tanggal</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Nama Santri</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Kelas</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Pelanggaran</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Status</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-slate-300">Penanganan /
                                    Petugas</th>
                            </tr>
                        </thead>
                        <tbody id="reportBody" class="divide-y divide-white/5">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-slate-400">Silakan set tanggal dan klik
                                    Tampilkan</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="resultCount" class="text-slate-400 text-sm text-right mt-3"></div>
            </div>
        </div>

        <!-- PRINT-ONLY HEADER (Professional Letterhead) -->
        <div class="print-header">
            <h1>SIE. KEAMANAN PPS SHIROTHUL FUQOHA'</h1>
            <h2>Sistem Informasi Manajemen Pelanggaran & Perizinan</h2>
            <p>
                Jl Basuki Rahmat No.104 Sepanjang Gondanglegi Malang | Telp: 085749527084 | Email:
                www.pondoksepanjang.com
            </p>
            <div class="line-separator"></div>
        </div>

        <!-- PRINT-ONLY REPORT TITLE -->
        <div class="report-title">
            <h3>LAPORAN DATA PELANGGARAN SANTRI</h3>
            <p id="print-period">Periode: <span id="printDateRange"></span></p>
        </div>

        <!-- PRINT-ONLY METADATA -->
        <div class="print-meta">
            Dicetak pada: <span id="printDateTime"></span>
        </div>
    </div>

    <style>
        /* Print Header - Only visible when printing */
        .print-header {
            display: none;
        }

        .report-title {
            display: none;
        }

        .print-meta {
            display: none;
        }

        @media print {

            /* CRITICAL: Override ALL Tailwind/page styles */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                box-sizing: border-box !important;
            }

            /* Page Setup */
            @page {
                size: A4 portrait;
                margin: 15mm 12mm;
            }

            html,
            body {
                width: 100% !important;
                height: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                color: #000 !important;
            }

            body {
                font-family: 'Arial', sans-serif !important;
                font-size: 10pt !important;
                line-height: 1.4 !important;
            }

            /* Force remove ALL purple/indigo backgrounds */
            body,
            body *,
            #app,
            #app *,
            .bg-gradient-to-br,
            .from-indigo-900,
            .via-purple-900,
            .to-slate-900,
            div[class*="indigo"],
            div[class*="purple"],
            div[class*="slate"] {
                background: white !important;
                background-color: white !important;
                background-image: none !important;
            }

            /* Hide ALL non-print elements */
            .no-print,
            button,
            .bg-slate-800\/70>div:first-child,
            nav,
            header,
            .print-button,
            #app>div>div:first-child {
                display: none !important;
            }

            /* Print Header - Professional Letterhead */
            .print-header {
                display: block !important;
                text-align: center;
                border-bottom: 3px solid #000;
                padding-bottom: 12px;
                margin-bottom: 20px;
                page-break-after: avoid;
                background: white !important;
            }

            .print-header h1 {
                margin: 0 0 5px 0 !important;
                font-size: 18pt !important;
                font-weight: bold !important;
                text-transform: uppercase !important;
                letter-spacing: 1.5px !important;
                color: #000 !important;
                background: none !important;
            }

            .print-header h2 {
                margin: 0 0 8px 0 !important;
                font-size: 14pt !important;
                font-weight: bold !important;
                color: #000 !important;
                background: none !important;
            }

            .print-header p {
                margin: 3px 0 !important;
                font-size: 9pt !important;
                line-height: 1.5 !important;
                color: #333 !important;
                background: none !important;
            }

            .print-header .line-separator {
                height: 2px !important;
                background: #000 !important;
                margin: 8px auto 0 !important;
                width: 100% !important;
                border: none !important;
            }

            /* Report Title */
            .report-title {
                display: block !important;
                text-align: center;
                margin: 15px 0 20px 0 !important;
                page-break-after: avoid;
                background: white !important;
            }

            .report-title h3 {
                margin: 0 0 6px 0 !important;
                font-size: 14pt !important;
                font-weight: bold !important;
                text-transform: uppercase !important;
                text-decoration: underline !important;
                letter-spacing: 1px !important;
                color: #000 !important;
                background: none !important;
            }

            .report-title p {
                margin: 0 !important;
                font-size: 10pt !important;
                font-weight: normal !important;
                color: #000 !important;
                background: none !important;
            }

            /* Main Content Container */
            .bg-slate-800\/70,
            .bg-slate-800\/70 * {
                background: white !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
            }

            /* Table Container */
            .overflow-x-auto {
                overflow: visible !important;
                background: white !important;
            }

            /* Table Styling - Clean Professional */
            #reportTable {
                width: 100% !important;
                border-collapse: collapse !important;
                margin: 15px 0 !important;
                font-size: 9pt !important;
                background: white !important;
                border: 2px solid #000 !important;
            }

            #reportTable * {
                background: white !important;
            }

            #reportTable thead {
                background: #000 !important;
            }

            #reportTable thead tr {
                background: #000 !important;
            }

            #reportTable th {
                background: #000 !important;
                color: #fff !important;
                border: 1px solid #000 !important;
                padding: 10px 6px !important;
                font-weight: bold !important;
                text-align: left !important;
                vertical-align: middle !important;
                font-size: 9pt !important;
                text-transform: uppercase !important;
                letter-spacing: 0.5px !important;
            }

            #reportTable tbody {
                background: white !important;
            }

            #reportTable tbody tr {
                background: white !important;
                page-break-inside: avoid !important;
            }

            #reportTable tbody tr:nth-child(even) {
                background: #f5f5f5 !important;
            }

            #reportTable td {
                border: 1px solid #999 !important;
                color: #000 !important;
                background: inherit !important;
                padding: 8px 6px !important;
                vertical-align: top !important;
                line-height: 1.3 !important;
            }

            /* Cell content styling */
            #reportTable td strong {
                font-weight: bold !important;
                color: #000 !important;
            }

            #reportTable td small,
            #reportTable td .text-muted {
                font-size: 8pt !important;
                color: #555 !important;
                display: block !important;
                margin-top: 2px !important;
            }

            #reportTable td br {
                display: block !important;
                content: "" !important;
                margin: 2px 0 !important;
            }

            /* Status colors - professional tones */
            #reportTable td[style*="color: rgb(34, 197, 94)"],
            #reportTable td[style*="color:#22c55e"],
            #reportTable td[style*="color: rgb(34,197,94)"] {
                color: #2d7a2d !important;
                font-weight: bold !important;
            }

            #reportTable td[style*="color: rgb(239, 68, 68)"],
            #reportTable td[style*="color:#ef4444"],
            #reportTable td[style*="color: rgb(239,68,68)"] {
                color: #c62828 !important;
                font-weight: bold !important;
            }

            #reportTable td[style*="color: rgb(245, 158, 11)"],
            #reportTable td[style*="color:#f59e0b"],
            #reportTable td[style*="color: rgb(245,158,11)"] {
                color: #c77700 !important;
                font-weight: bold !important;
            }

            /* Print Metadata Footer */
            .print-meta {
                display: block !important;
                text-align: right;
                margin-top: 15px !important;
                padding-top: 10px !important;
                border-top: 1px solid #ccc !important;
                font-size: 8pt !important;
                color: #666 !important;
                page-break-inside: avoid !important;
                background: white !important;
            }

            /* Result count */
            #resultCount {
                display: block !important;
                text-align: left;
                margin: 15px 0 10px 0 !important;
                font-size: 9pt !important;
                font-weight: bold !important;
                color: #000 !important;
                padding: 8px 12px !important;
                background: #f0f0f0 !important;
                border-left: 4px solid #000 !important;
                page-break-inside: avoid !important;
            }

            /* Page break control */
            tr {
                page-break-inside: avoid !important;
            }

            thead {
                display: table-header-group !important;
            }

            tfoot {
                display: table-footer-group !important;
            }

            /* Avoid breaking after headers */
            h1,
            h2,
            h3,
            .print-header,
            .report-title {
                page-break-after: avoid !important;
            }

            /* Force clean backgrounds everywhere */
            table,
            tbody,
            tr,
            td:not(#reportTable th) {
                background: white !important;
            }
        }
    </style>

    <script src="assets/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            renderLayout('laporan');
            document.getElementById('pageTitle').innerText = 'Laporan';
            document.getElementById('pageSubtitle').innerText = 'Export & Filter';

            // Default: Tanggal kosong (tampilkan semua data)
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';

            // Populate print metadata
            updatePrintMetadata();

            loadReport();
        });

        // Function to update print metadata
        function updatePrintMetadata() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // Format tanggal untuk Indonesia
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                const d = new Date(dateStr);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return d.toLocaleDateString('id-ID', options);
            };

            // Update date range
            document.getElementById('printDateRange').innerText =
                `${formatDate(startDate)} s/d ${formatDate(endDate)}`;

            // Update print timestamp
            const printTime = new Date();
            const timeOptions = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('printDateTime').innerText =
                printTime.toLocaleDateString('id-ID', timeOptions);
        }

        // Global variable untuk menyimpan raw data dari server
        let rawData = [];
        let filteredData = [];

        async function loadReport() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            // Update print metadata whenever report is loaded
            updatePrintMetadata();

            const tbody = document.getElementById('reportBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Memuat data...</td></tr>';

            // 1. Ambil data dari API
            // Jika tanggal kosong, jangan kirim parameter (ambil semua data)
            let apiUrl = 'pelanggaran.php?action=list';
            if (start && end) {
                apiUrl += `&start=${start}&end=${end}`;
            }
            const res = await apiCall(apiUrl);

            if (res && res.data) {
                rawData = res.data;
                applyFilters(); // 2. Terapkan filter teks
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Gagal memuat data</td></tr>';
            }
        }

        // Fungsi filter client-side yang responsif
        function applyFilters() {
            const fNama = document.getElementById('filterNama').value.toLowerCase();
            const fKelas = document.getElementById('filterKelas').value.toLowerCase();
            const fAsrama = document.getElementById('filterAsrama').value.toLowerCase();

            // Filter Array
            filteredData = rawData.filter(row => {
                const matchNama = row.nama?.toLowerCase().includes(fNama) || false;
                const matchKelas = row.kelas?.toLowerCase().includes(fKelas) || false;
                const matchAsrama = row.asrama?.toLowerCase().includes(fAsrama) || false;
                return matchNama && matchKelas && matchAsrama;
            });

            renderTable(filteredData);
        }

        function renderTable(data) {
            const tbody = document.getElementById('reportBody');
            tbody.innerHTML = '';

            if (data.length > 0) {
                document.getElementById('resultCount').innerText = `Menampilkan ${data.length} data`;

                data.forEach(row => {
                    // Warna status
                    let color = 'white';
                    if (row.status_penanganan?.includes('Selesai')) color = '#22c55e';
                    else if (row.status_penanganan?.includes('Belum')) color = '#ef4444';
                    else color = '#f59e0b';

                    // Info Petugas
                    const pelapor = row.pencatat || 'System';
                    const penangan = row.penangan ? row.penangan : '-';

                    tbody.innerHTML += `
                        <tr>
                            <td>${row.tanggal_kejadian}</td>
                            <td>
                                <strong>${row.nama}</strong><br>
                                <small style="opacity:0.7">${row.santri_nis}</small>
                            </td>
                            <td>
                                ${row.kelas}<br>
                                <small style="opacity:0.7">${row.asrama}</small>
                            </td>
                            <td>
                                ${row.jenis_pelanggaran}<br>
                                <span style="font-size:0.8em; opacity:0.7; border:1px solid rgba(255,255,255,0.2); padding: 0 4px; border-radius:4px;">${row.kategori}</span>
                            </td>
                            <td style="color:${color}; font-weight:bold;">${row.status_penanganan || 'Belum'}</td>
                            <td>
                                <div style="font-size:0.9em; line-height:1.4em;">
                                    Tindakan: ${row.tindakan_diambil || '-'}<br>
                                    <small style="opacity:0.6; display:block; margin-top:4px; border-top:1px solid rgba(255,255,255,0.1); padding-top:4px;">
                                        <i class='bx bxs-user-voice'></i> Lapor: ${pelapor}<br>
                                        <i class='bx bxs-user-check'></i> Eksekusi: ${penangan}
                                    </small>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada data yang cocok dengan filter</td></tr>';
                document.getElementById('resultCount').innerText = '';
            }
        }

        // Reset Filter Function
        function resetFilter(e) {
            // Reset all filter inputs (kosongkan semua)
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('filterNama').value = '';
            document.getElementById('filterKelas').value = '';
            document.getElementById('filterAsrama').value = '';

            // Reload data (tampilkan semua data)
            loadReport();

            // Visual feedback
            const btn = e ? e.target.closest('button') : null;
            if (btn) {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="bx bx-check"></i> Reset!';
                btn.classList.add('bg-green-600');

                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('bg-green-600');
                }, 1000);
            }
        }

        // Tambahkan event listener 
        ['filterNama', 'filterKelas', 'filterAsrama'].forEach(id => {
            document.getElementById(id).addEventListener('keyup', applyFilters);
        });

        function exportExcel() {
            if (filteredData.length === 0) {
                alert('Tidak ada data untuk diexport');
                return;
            }

            // Format data untuk excel agar rapi (termasuk kolom petugas)
            const excelData = filteredData.map(row => ({
                "Tanggal": row.tanggal_kejadian,
                "NIS": row.santri_nis,
                "Nama Santri": row.nama,
                "Kelas": row.kelas,
                "Asrama": row.asrama,
                "Pelanggaran": row.jenis_pelanggaran,
                "Status": row.status_penanganan,
                "Tindakan": row.tindakan_diambil || '-',
                "Pelapor": row.pencatat || 'System',
                "Penangan (Eksekutor)": row.penangan || '-'
            }));

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan SimpelPanel");
            XLSX.writeFile(wb, "Laporan_Pelanggaran_Lengkap.xlsx");
        }
    </script>
</body>

</html>