<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=400, initial-scale=1.0">
    <title>Cetak Kartu Izin</title>
    <style>
        @page {
            margin: 0;
            size: auto;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-print-color-adjust: exact;
        }

        body {
            width: 400px;
            /* Menyesuaikan dengan lebar cetak printer thermal */
            margin: 0 auto;
            font-family: Arial, sans-serif;
            background: white;
            color: black;
            line-height: 1.2;
        }

        .ticket {
            width: 100%;
            padding: 20px;
        }

        .text-center {
            text-align: center;
        }

        .uppercase {
            text-transform: uppercase;
        }

        .font-bold {
            font-weight: bold;
        }

        /* Logo Sharpness */
        .logo {
            width: 160px;
            display: block;
            margin: 0 auto 10px;
            filter: grayscale(1) contrast(1.2);
            image-rendering: -webkit-optimize-contrast;
        }

        .header-title {
            font-size: 16pt;
            margin-bottom: 2px;
        }

        .header-subtitle {
            font-size: 14pt;
            margin-bottom: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 13pt;
            margin: 4px 0;
        }

        .line {
            border-bottom: 3px solid black;
            margin: 10px 0;
        }

        .line-dashed {
            border-bottom: 2px dashed black;
            margin: 10px 0;
        }

        .label {
            font-size: 11pt;
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 12px;
            display: block;
        }

        .value {
            font-size: 14pt;
            font-weight: bold;
            text-transform: uppercase;
            display: block;
        }

        .value-small {
            font-size: 14pt;
            font-weight: normal;
            text-transform: none;
            /* Keterangan tambahan biasanya lebih panjang, non-caps lebih enak dibaca */
            margin-top: 2px;
        }

        .return-box {
            border: 4px solid black;
            text-align: center;
            padding: 12px;
            margin: 12px 0;
        }

        .return-time {
            font-size: 22pt;
            font-weight: 900;
        }

        .footer {
            font-size: 16pt;
            text-align: center;
            margin-top: 20px;
            border-top: 1px dashed black;
            padding-top: 10px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <div id="loading" style="padding: 100px 20px; text-align: center; font-size: 18pt;">
        MEMUAT DATA...
    </div>

    <div id="content" class="ticket hidden">
        <div class="text-center">
            <img src="https://keamanan.pondoksepanjang.com/LOGO.png" class="logo">
            <div class="header-title font-bold uppercase">KEAMANAN <br> PPS SHIROTHUL FUQOHA</div>
            <div class="header-subtitle uppercase">Surat Izin Keluar</div>
        </div>

        <div class="line"></div>

        <div class="info-row"><span class="font-bold">TANGGAL:</span><span id="p-date">-</span></div>
        <div class="info-row"><span class="font-bold">JAM:</span><span id="p-time">-</span></div>
        <div class="info-row"><span class="font-bold">PETUGAS:</span><span id="p-petugas">-</span></div>

        <div class="line-dashed"></div>

        <div class="label">Nama Santri:</div>
        <div class="value" id="p-nama">-</div>
        <div id="p-detail" style="font-size: 12pt;">-</div>

        <div class="label">Tujuan Izin:</div>
        <div class="value" id="p-tujuan">-</div>

        <div id="wrapper-keterangan" class="hidden">
            <div class="label">Keterangan Tambahan:</div>
            <div class="value-small" id="p-keterangan">-</div>
        </div>

        <div class="line" style="border-width: 5px;"></div>

        <div class="text-center font-bold" style="font-size: 13pt; margin-bottom: 5px;">WAJIB KEMBALI SEBELUM:</div>
        <div class="return-box">
            <div class="return-time" id="p-kembali">-</div>
        </div>

        <div class="footer">
            <b>Simpan kartu ini & serahkan<br>ke petugas saat kembali.<br> Terlambat = Sanksi !</b>
        </div>
    </div>

    <script src="assets/js/main.js"></script>
    <script>
        async function loadAndPrint() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            if (!id) {
                document.getElementById('loading').innerText = "ERROR: ID TIDAK DITEMUKAN";
                return;
            }

            try {
                // Pastikan fungsi apiCall tersedia di main.js
                const res = await apiCall(`perizinan.php?action=read&id=${id}`);

                if (res) {
                    const d = new Date(res.waktu_keluar);
                    const k = new Date(res.rencana_kembali);

                    // 1. Data Waktu & Petugas
                    document.getElementById('p-date').innerText = d.toLocaleDateString('id-ID');
                    document.getElementById('p-time').innerText = d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }).replace('.', ':');
                    document.getElementById('p-petugas').innerText = (res.petugas_nama || 'ADMIN').split(' ')[0].toUpperCase();

                    // 2. Data Santri
                    document.getElementById('p-nama').innerText = res.nama || '-';
                    document.getElementById('p-detail').innerText = `${res.kelas || ''} - ${res.asrama || ''}`;

                    // 3. Data Izin & Keterangan (Dua Kolom Berbeda)
                    document.getElementById('p-tujuan').innerText = res.tujuan_izin || "-";

                    // Cek jika ada keterangan tambahan (bisa res.keterangan atau res.keterangan_tambahan)
                    const ket = res.keterangan || res.keterangan_tambahan || "";
                    if (ket && ket !== "-" && ket !== res.tujuan_izin) {
                        document.getElementById('p-keterangan').innerText = ket;
                        document.getElementById('wrapper-keterangan').classList.remove('hidden');
                    }

                    // 4. Batas Kembali
                    const kDay = k.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const kTime = k.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }).replace('.', ':');
                    document.getElementById('p-kembali').innerText = `${kDay} ${kTime}`;

                    // Tampilkan Konten
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('content').classList.remove('hidden');

                    // Eksekusi Print dengan jeda agar rendering selesai
                    setTimeout(() => {
                        window.print();
                    }, 1000);

                } else {
                    document.getElementById('loading').innerText = "DATA TIDAK DITEMUKAN";
                }
            } catch (error) {
                console.error("Print Error:", error);
                document.getElementById('loading').innerText = "GAGAL MENGAMBIL DATA API";
            }
        }

        // Jalankan saat halaman dibuka
        window.onload = loadAndPrint;
    </script>
</body>

</html>